---
 texk/seetexk/ChangeLog    |    7 ++++
 texk/seetexk/dviconcat.c  |    1 
 texk/seetexk/dviselect.c  |   67 ++++++++++++++++++++++++++++++++--------------
 texk/seetexk/seetexk.test |   21 +++++++++++++-
 4 files changed, 74 insertions(+), 22 deletions(-)

--- texlive-bin.orig/texk/seetexk/ChangeLog
+++ texlive-bin/texk/seetexk/ChangeLog
@@ -1,3 +1,10 @@
+2013-11-20  Peter Breitenlohner  <peb@mppmu.mpg.de>
+
+	* dviselect.c: Delay opening output until a page is selected.
+	* seetexk.test: More tests with stdin and stdout.
+
+	* dviconcat.c: Drop '#include <kpathsea/c-auto.h>'.
+
 2013-11-18  Peter Breitenlohner  <peb@mppmu.mpg.de>
 
 	* seetexk.test: Add a test for dviselect creating 0 pages.
--- texlive-bin.orig/texk/seetexk/dviconcat.c
+++ texlive-bin/texk/seetexk/dviconcat.c
@@ -29,7 +29,6 @@
 #endif
 
 #ifdef KPATHSEA
-#include <kpathsea/c-auto.h>
 #include <kpathsea/c-fopen.h>
 #include <kpathsea/getopt.h>
 #else
--- texlive-bin.orig/texk/seetexk/dviselect.c
+++ texlive-bin/texk/seetexk/dviselect.c
@@ -132,9 +132,10 @@
 
 struct	pagelist *PageList;	/* the list of allowed pages */
 
-const char	*DVIFileName;		/* name of input DVI file */
-FILE	*inf;			/* the input file itself */
-FILE	*outf;			/* the output DVI file */
+const char	*DVIFileName;	/* name of input DVI file */
+FILE		*inf;		/* the input file itself */
+const char	*outname;	/* name of output DVI file */
+FILE		*outf;		/* the output DVI file */
 
 long	StartOfLastPage;	/* The file position just before we started
 				   the last page (this is later written to
@@ -162,6 +163,7 @@
 static int ParsePages(char *);
 static void HandleDVIFile(void);
 static void PutFontSelector(i32);
+static void WritePreAmble(void);
 
 #ifdef _AMIGA
 #define bcmp(s1, s2, len) memcmp(s1, s2, len)
@@ -287,6 +289,9 @@
 	if ((UseThisPage = DesiredPageP()) == 0)
 		return;
 
+	if (NumberOfOutputPages == 0)
+		WritePreAmble();
+
 	putbyte(outf, DVI_BOP);
 	for (i = Count; i < &Count[10]; i++)
 		PutLong(outf, *i);
@@ -354,6 +359,9 @@
 {
 	register i32 c;
 
+	if (NumberOfOutputPages == 0)
+		return;
+
 	(void) GetLong(inf);	/* previous page pointer */
 	if (GetLong(inf) != Numerator)
 		GripeMismatchedValue("numerator");
@@ -446,12 +454,18 @@
 }
 
 /*
- * Handle the preamble.  Someday we should update the comment field.
+ * Array to hold the preamble comment.
+ */
+static char PreComment[256];
+
+/*
+ * Read the preamble.  Someday we should update the comment field.
  */
 static void
-HandlePreAmble(void)
+ReadPreAmble(void)
 {
 	register int n, c;
+	char *comment = PreComment;
 
 	c = getc(inf);
 	if (c == EOF)
@@ -464,17 +478,43 @@
 	Numerator = GetLong(inf);
 	Denominator = GetLong(inf);
 	DVIMag = GetLong(inf);
+	c = GetByte(inf);
+	n = UnSign8(c);
+	*comment++ = (char)c;
+	while (--n >= 0) {
+		c = GetByte(inf);
+		*comment++ = (char)c;
+	}
+}
+
+/*
+ * Open the output and write the preamble.
+ */
+static void
+WritePreAmble(void)
+{
+	register int n, c;
+	char *comment = PreComment;
+
+	if (outname == NULL) {
+		outf = stdout;
+		if (!isatty(fileno(outf)))
+		  SET_BINARY(fileno(outf));
+	} else if ((outf = fopen(outname, FOPEN_WBIN_MODE)) == 0)
+		error(1, -1, "cannot write %s", outname);
+
 	putbyte(outf, DVI_PRE);
 	putbyte(outf, DVI_VERSION);
 	PutLong(outf, Numerator);
 	PutLong(outf, Denominator);
 	PutLong(outf, DVIMag);
 
-	n = UnSign8(GetByte(inf));
+	c = *comment++;
+	n = UnSign8(c);
 	CurrentPosition = 15 + n;	/* well, almost */
 	putbyte(outf, n);
 	while (--n >= 0) {
-		c = GetByte(inf);
+		c = *comment++;
 		putbyte(outf, c);
 	}
 }
@@ -484,7 +524,6 @@
 {
 	register int c;
 	register char *s;
-	char *outname = NULL;
 
 	ProgName = *argv;
 	setbuf(stderr, serrbuf);
@@ -543,18 +582,12 @@
 		  SET_BINARY(fileno(inf));
 	} else if ((inf = fopen(DVIFileName, FOPEN_RBIN_MODE)) == 0)
 		error(1, -1, "cannot read %s", DVIFileName);
-	if (outname == NULL) {
-		outf = stdout;
-		if (!isatty(fileno(outf)))
-		  SET_BINARY(fileno(outf));
-	} else if ((outf = fopen(outname, FOPEN_WBIN_MODE)) == 0)
-		error(1, -1, "cannot write %s", outname);
 
 	if ((FontFinder = SCreate(sizeof(struct fontinfo))) == 0)
 		error(1, 0, "cannot create font finder (out of memory?)");
 
 	StartOfLastPage = -1;
-	HandlePreAmble();
+	ReadPreAmble();
 	HandleDVIFile();
 	HandlePostAmble();
 	if (NumberOfOutputPages > 0) {
@@ -566,10 +599,6 @@
 	} else {
 		if (!SFlag)
 			(void) fprintf(stderr, "Specified page may be out of range\n");
-		if (outname) {
-			fclose (outf);
-			unlink (outname);
-		}
 		return 1;
 	}
 }
--- texlive-bin.orig/texk/seetexk/seetexk.test
+++ texlive-bin/texk/seetexk/seetexk.test
@@ -26,6 +26,23 @@
 
 echo dviselect tests OK
 
+rm -rf play*
+cat $srcdir/tests/play.dvi | ./dviselect =25 >playsel.dvi \
+	2>playsel.2 \
+	&& exit 1
+	touch playnot.dvi \
+	&& diff playsel.dvi playnot.dvi \
+	&& diff playsel.2 $srcdir/tests/playnot.2 \
+	|| exit 1
+
+rm -rf play*
+cat $srcdir/tests/play.dvi | ./dviselect =5:15 >playsel.dvi \
+	2>playsel.2 \
+	&& diff playsel.2 $srcdir/tests/playsel.2 \
+	|| exit 1
+
+echo dviselect with stdin and stdout tests OK
+
 ./dvibook -s4 playsel.dvi playbook.dvi \
 	2>playbook.2 \
 	&& diff playbook.2 $srcdir/tests/playbook.2 \
@@ -35,12 +52,12 @@
 
 rm -f playbook.2
 
-cat playsel.dvi | ./dvibook -s4 -o playbook.dvi \
+cat playsel.dvi | ./dvibook -s4 >playbook.dvi \
 	2>playbook.2 \
 	&& diff playbook.2 $srcdir/tests/playbook.2 \
 	|| exit 1
 
-echo dvibook reading stdin tests OK
+echo dvibook with stdin and stdout tests OK
 
 ./dviselect =5:7 $srcdir/tests/play.dvi playsel1.dvi \
 	2>playconc.2 \
