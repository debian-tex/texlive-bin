From: TANAKA Takuji <ttk@t-lab.opal.ne.jp>
Subject: Fixes for bibtex-x #2
Origin: upstream

diff --git a/texk/bibtex-x/ChangeLog b/texk/bibtex-x/ChangeLog
index 04a103d84..8ea45a55c 100644
--- a/texk/bibtex-x/ChangeLog
+++ b/texk/bibtex-x/ChangeLog
@@ -1,3 +1,8 @@
+2023-04-10  TANAKA Takuji  <ttk@t-lab.opal.ne.jp>
+
+	* tests/substr[au].bbl, tests/testsubstr.bst:
+	Add more tests for substring$.
+
 2023-01-29  Karl Berry  <karl@freefriends.org>
 
 	* tests/bibtexu-sort.test,
diff --git a/texk/bibtex-x/tests/substra.bbl b/texk/bibtex-x/tests/substra.bbl
index 9b182f7f2..fafdba390 100644
--- a/texk/bibtex-x/tests/substra.bbl
+++ b/texk/bibtex-x/tests/substra.bbl
@@ -55,6 +55,11 @@
 \item[-6 3]  tu
 \item[-7 2]  t
 \item[-8 1]
+\item[1 1, 1 1] A
+\item[2 1, 1 1] B
+\item[3 1, 1 1] C
+\item[4 1, 1 1] D
+\item[5 1, 1 1] E
 \item[orig] ÅÇÈÎØÜİ~åçèîøüı
 \item[1 5] ÅÇÈÎØ
 \item[1 4] ÅÇÈÎ
@@ -110,6 +115,11 @@
 \item[-6 3] ~åç
 \item[-7 2] ~å
 \item[-8 1] ~
+\item[1 1, 1 1] Å
+\item[2 1, 1 1] Ç
+\item[3 1, 1 1] È
+\item[4 1, 1 1] Î
+\item[5 1, 1 1] Ø
 \item[orig] {AB}CDEFG tuvwx{yz}
 \item[1 5] {AB}C
 \item[1 4] {AB}
@@ -165,6 +175,11 @@
 \item[-6 3] uvw
 \item[-7 2] uv
 \item[-8 1] u
+\item[1 1, 1 1] {
+\item[2 1, 1 1] A
+\item[3 1, 1 1] B
+\item[4 1, 1 1] }
+\item[5 1, 1 1] C
 \item[orig] {{AB}CD}EFG tuv{wx{yz}}
 \item[1 5] {{AB}
 \item[1 4] {{AB
@@ -220,6 +235,11 @@
 \item[-6 3] {wx
 \item[-7 2] {w
 \item[-8 1] {
+\item[1 1, 1 1] {
+\item[2 1, 1 1] {
+\item[3 1, 1 1] A
+\item[4 1, 1 1] B
+\item[5 1, 1 1] }
 \item[orig] {{ÅÇ}ÈÎ}ØÜİ~åçè{îø{üı}}
 \item[1 5] {{ÅÇ}
 \item[1 4] {{ÅÇ
@@ -275,6 +295,11 @@
 \item[-6 3] {îø
 \item[-7 2] {î
 \item[-8 1] {
+\item[1 1, 1 1] {
+\item[2 1, 1 1] {
+\item[3 1, 1 1] Å
+\item[4 1, 1 1] Ç
+\item[5 1, 1 1] }
 \item[orig] {\a}Åå{\b}Ææ{\c}Çç
 \item[1 5] {\a}Å
 \item[1 4] {\a}
@@ -330,5 +355,10 @@
 \item[-6 3] Ææ{
 \item[-7 2] Ææ
 \item[-8 1] Æ
+\item[1 1, 1 1] {
+\item[2 1, 1 1] \
+\item[3 1, 1 1] a
+\item[4 1, 1 1] }
+\item[5 1, 1 1] Å
 \end{itemize}
 \endinput
diff --git a/texk/bibtex-x/tests/substru.bbl b/texk/bibtex-x/tests/substru.bbl
index 48e2601b8..c8b6ef5f7 100644
--- a/texk/bibtex-x/tests/substru.bbl
+++ b/texk/bibtex-x/tests/substru.bbl
@@ -55,6 +55,11 @@
 \item[-6 3]  tu
 \item[-7 2]  t
 \item[-8 1]
+\item[1 1, 1 1] A
+\item[2 1, 1 1] B
+\item[3 1, 1 1] C
+\item[4 1, 1 1] D
+\item[5 1, 1 1] E
 \item[orig] Ã…Ã‡ÃˆÃÃ˜ÃœÃ~Ã¥Ã§Ã¨Ã®Ã¸Ã¼Ã½
 \item[1 5] Ã…Ã‡ÃˆÃÃ˜
 \item[1 4] Ã…Ã‡ÃˆÃ
@@ -110,6 +115,11 @@
 \item[-6 3] ~Ã¥Ã§
 \item[-7 2] ~Ã¥
 \item[-8 1] ~
+\item[1 1, 1 1] Ã…
+\item[2 1, 1 1] Ã‡
+\item[3 1, 1 1] Ãˆ
+\item[4 1, 1 1] Ã
+\item[5 1, 1 1] Ã˜
 \item[orig] AÃ‡ã†ğ¯ ˜EÃœĞ–~tÃ§ãƒ¦æ¼†ğ¡š´xÑÏ‰
 \item[1 5] AÃ‡ã†ğ¯ ˜E
 \item[1 4] AÃ‡ã†ğ¯ ˜
@@ -165,6 +175,11 @@
 \item[-6 3] tÃ§ãƒ¦
 \item[-7 2] tÃ§
 \item[-8 1] t
+\item[1 1, 1 1] A
+\item[2 1, 1 1] Ã‡
+\item[3 1, 1 1] ã†
+\item[4 1, 1 1] ğ¯ ˜
+\item[5 1, 1 1] E
 \item[orig] {AB}CDEFG tuvwx{yz}
 \item[1 5] {AB}C
 \item[1 4] {AB}
@@ -220,6 +235,11 @@
 \item[-6 3] uvw
 \item[-7 2] uv
 \item[-8 1] u
+\item[1 1, 1 1] {
+\item[2 1, 1 1] A
+\item[3 1, 1 1] B
+\item[4 1, 1 1] }
+\item[5 1, 1 1] C
 \item[orig] {\a}Ã…Ã¥{\b}Ã†Ã¦{\c}Ã‡Ã§
 \item[1 5] {\a}Ã…
 \item[1 4] {\a}
@@ -275,6 +295,11 @@
 \item[-6 3] Ã†Ã¦{
 \item[-7 2] Ã†Ã¦
 \item[-8 1] Ã†
+\item[1 1, 1 1] {
+\item[2 1, 1 1] \
+\item[3 1, 1 1] a
+\item[4 1, 1 1] }
+\item[5 1, 1 1] Ã…
 \item[orig] {\a}Î±ã‚{\b}Î²ã„{\c}Î³ã†
 \item[1 5] {\a}Î±
 \item[1 4] {\a}
@@ -330,6 +355,11 @@
 \item[-6 3] Î²ã„{
 \item[-7 2] Î²ã„
 \item[-8 1] Î²
+\item[1 1, 1 1] {
+\item[2 1, 1 1] \
+\item[3 1, 1 1] a
+\item[4 1, 1 1] }
+\item[5 1, 1 1] Î±
 \item[orig] {\a}ã‚Î±{\b}ã„Î²{\c}ã†Î³
 \item[1 5] {\a}ã‚
 \item[1 4] {\a}
@@ -385,6 +415,11 @@
 \item[-6 3] ã„Î²{
 \item[-7 2] ã„Î²
 \item[-8 1] ã„
+\item[1 1, 1 1] {
+\item[2 1, 1 1] \
+\item[3 1, 1 1] a
+\item[4 1, 1 1] }
+\item[5 1, 1 1] ã‚
 \item[orig] {{AB}CD}EFG tuv{wx{yz}}
 \item[1 5] {{AB}
 \item[1 4] {{AB
@@ -440,6 +475,11 @@
 \item[-6 3] {wx
 \item[-7 2] {w
 \item[-8 1] {
+\item[1 1, 1 1] {
+\item[2 1, 1 1] {
+\item[3 1, 1 1] A
+\item[4 1, 1 1] B
+\item[5 1, 1 1] }
 \item[orig] {{Ã…Ã‡}ÃˆÃ}Ã˜ÃœÃ~Ã¥Ã§Ã¨{Ã®Ã¸{Ã¼Ã½}}
 \item[1 5] {{Ã…Ã‡}
 \item[1 4] {{Ã…Ã‡
@@ -495,6 +535,11 @@
 \item[-6 3] {Ã®Ã¸
 \item[-7 2] {Ã®
 \item[-8 1] {
+\item[1 1, 1 1] {
+\item[2 1, 1 1] {
+\item[3 1, 1 1] Ã…
+\item[4 1, 1 1] Ã‡
+\item[5 1, 1 1] }
 \item[orig] {{ä¸€äºŒ}ä¸‰å››}äº”å…­ä¸ƒã€€è‚†ä¼é™¸{æ¼†æŒ{ç–æ‹¾}}
 \item[1 5] {{ä¸€äºŒ}
 \item[1 4] {{ä¸€äºŒ
@@ -550,6 +595,11 @@
 \item[-6 3] {æ¼†æŒ
 \item[-7 2] {æ¼†
 \item[-8 1] {
+\item[1 1, 1 1] {
+\item[2 1, 1 1] {
+\item[3 1, 1 1] ä¸€
+\item[4 1, 1 1] äºŒ
+\item[5 1, 1 1] }
 \item[orig]
   {{ğ¯£­ğ¯£œ}ğ¯¡·ğ¯ ˜}ğ¦¥‘ğ ®Ÿğ €‹ğ¡ˆ½ğ¥±ğ¨¦‡ğ¡š´{ğ ·¡ğ§˜•{ğ§˜”ğ©¸½}}
 \item[1 5] {{ğ¯£­ğ¯£œ}
@@ -606,6 +656,11 @@
 \item[-6 3] {ğ ·¡ğ§˜•
 \item[-7 2] {ğ ·¡
 \item[-8 1] {
+\item[1 1, 1 1] {
+\item[2 1, 1 1] {
+\item[3 1, 1 1] ğ¯£­
+\item[4 1, 1 1] ğ¯£œ
+\item[5 1, 1 1] }
 \item[orig] Î‘Î’Î“Î”Î•Î–Î— ÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰
 \item[1 5] Î‘Î’Î“Î”Î•
 \item[1 4] Î‘Î’Î“Î”
@@ -661,6 +716,11 @@
 \item[-6 3]  ÏƒÏ„
 \item[-7 2]  Ïƒ
 \item[-8 1]
+\item[1 1, 1 1] Î‘
+\item[2 1, 1 1] Î’
+\item[3 1, 1 1] Î“
+\item[4 1, 1 1] Î”
+\item[5 1, 1 1] Î•
 \item[orig] ĞĞ‘Ğ’Ğ“Ğ”Ğ•Ğ– Ñ‰ÑŠÑ‹ÑŒÑÑÑ
 \item[1 5] ĞĞ‘Ğ’Ğ“Ğ”
 \item[1 4] ĞĞ‘Ğ’Ğ“
@@ -716,6 +776,11 @@
 \item[-6 3]  Ñ‰ÑŠ
 \item[-7 2]  Ñ‰
 \item[-8 1]
+\item[1 1, 1 1] Ğ
+\item[2 1, 1 1] Ğ‘
+\item[3 1, 1 1] Ğ’
+\item[4 1, 1 1] Ğ“
+\item[5 1, 1 1] Ğ”
 \item[orig] ã‚ã„ã†ãˆãŠã‹ãã€€ãƒ¦ãƒ¨ãƒ¯ãƒ°ãƒ±ãƒ²ãƒ³
 \item[1 5] ã‚ã„ã†ãˆãŠ
 \item[1 4] ã‚ã„ã†ãˆ
@@ -771,6 +836,11 @@
 \item[-6 3] ã€€ãƒ¦ãƒ¨
 \item[-7 2] ã€€ãƒ¦
 \item[-8 1] ã€€
+\item[1 1, 1 1] ã‚
+\item[2 1, 1 1] ã„
+\item[3 1, 1 1] ã†
+\item[4 1, 1 1] ãˆ
+\item[5 1, 1 1] ãŠ
 \item[orig] ä¸€äºŒä¸‰å››äº”å…­ä¸ƒã€€è‚†ä¼é™¸æ¼†æŒç–æ‹¾
 \item[1 5] ä¸€äºŒä¸‰å››äº”
 \item[1 4] ä¸€äºŒä¸‰å››
@@ -826,6 +896,11 @@
 \item[-6 3] ã€€è‚†ä¼
 \item[-7 2] ã€€è‚†
 \item[-8 1] ã€€
+\item[1 1, 1 1] ä¸€
+\item[2 1, 1 1] äºŒ
+\item[3 1, 1 1] ä¸‰
+\item[4 1, 1 1] å››
+\item[5 1, 1 1] äº”
 \item[orig] ğ¯£­ğ¯£œğ¯¡·ğ¯ ˜ğ¦¥‘ğ ®Ÿğ €‹ğ¡ˆ½ğ¥±ğ¨¦‡ğ¡š´ğ ·¡ğ§˜•ğ§˜”ğ©¸½
 \item[1 5] ğ¯£­ğ¯£œğ¯¡·ğ¯ ˜ğ¦¥‘
 \item[1 4] ğ¯£­ğ¯£œğ¯¡·ğ¯ ˜
@@ -881,5 +956,10 @@
 \item[-6 3] ğ¡ˆ½ğ¥±ğ¨¦‡
 \item[-7 2] ğ¡ˆ½ğ¥±
 \item[-8 1] ğ¡ˆ½
+\item[1 1, 1 1] ğ¯£­
+\item[2 1, 1 1] ğ¯£œ
+\item[3 1, 1 1] ğ¯¡·
+\item[4 1, 1 1] ğ¯ ˜
+\item[5 1, 1 1] ğ¦¥‘
 \end{itemize}
 \endinput
diff --git a/texk/bibtex-x/tests/testsubstr.bst b/texk/bibtex-x/tests/testsubstr.bst
index a332f82a0..206267d81 100644
--- a/texk/bibtex-x/tests/testsubstr.bst
+++ b/texk/bibtex-x/tests/testsubstr.bst
@@ -60,6 +60,11 @@ FUNCTION {output_entry} {
   "\item[-6 3] " field #-6 #3 substring$ * write$ newline$
   "\item[-7 2] " field #-7 #2 substring$ * write$ newline$
   "\item[-8 1] " field #-8 #1 substring$ * write$ newline$
+  "\item[1 1, 1 1] " field #1 #1 substring$ #1 #1 substring$ * write$ newline$
+  "\item[2 1, 1 1] " field #2 #1 substring$ #1 #1 substring$ * write$ newline$
+  "\item[3 1, 1 1] " field #3 #1 substring$ #1 #1 substring$ * write$ newline$
+  "\item[4 1, 1 1] " field #4 #1 substring$ #1 #1 substring$ * write$ newline$
+  "\item[5 1, 1 1] " field #5 #1 substring$ #1 #1 substring$ * write$ newline$
 }
 
 FUNCTION {type} {output_entry}
diff --git a/texk/web2c/uptexdir/ChangeLog b/texk/web2c/uptexdir/ChangeLog
index 137cffbc7..0f700a0f4 100644
--- a/texk/web2c/uptexdir/ChangeLog
+++ b/texk/web2c/uptexdir/ChangeLog
@@ -1,3 +1,9 @@
+2023-04-10  TANAKA Takuji  <ttk@t-lab.opal.ne.jp>
+
+	* upbibtex.ch: Fix bug of substring$
+	from Yukimasa Morimi san:
+	https://github.com/texjporg/tex-jp-build/issues/157
+
 2023-03-29  TANAKA Takuji  <ttk@t-lab.opal.ne.jp>
 
 	* wcfname.test:
diff --git a/texk/web2c/uptexdir/upbibtex.ch b/texk/web2c/uptexdir/upbibtex.ch
index e244606e6..fa46baba6 100644
--- a/texk/web2c/uptexdir/upbibtex.ch
+++ b/texk/web2c/uptexdir/upbibtex.ch
@@ -743,6 +743,23 @@ begin
 pop_lit2_saved := pop_lit2; {save before negate}
 @z
 
+@x 2023-04-08 texjporg/tex-jp-build#157
+        str_start[pop_lit3+1] := sp_end;
+@y
+        { |2..4| bytes Kanji code break check }
+        tpe:=str_start[pop_lit3];
+        mbl_tpe:=0;
+        while tpe < str_start[pop_lit3+1] do begin
+          mbl_tpe := multibytelen(str_pool[tpe]);
+            if mbl_tpe<0 {just in case}
+                or (str_start[pop_lit3+1] < tpe+mbl_tpe) then
+                break;
+            tpe := tpe + mbl_tpe;
+            if sp_end<=tpe then break;
+        end;
+        str_start[pop_lit3+1] := tpe;
+@z
+
 @x Changes for JBibTeX by Shouichi Matsui [438] + fix (2022-02-20 j0.34)
 str_room(sp_end - sp_ptr);
 while (sp_ptr < sp_end) do                      {shift the substring}
